<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- MEJORA DE SEGURIDAD 1: Pol√≠tica de Seguridad de Contenidos (CSP) -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://unpkg.com; 
        img-src 'self' data: https://*.basemaps.cartocdn.com https://artesparalapaz.mincultura.gov.co https://raw.githubusercontent.com;
        connect-src 'self' https://unpkg.com https://api.countapi.xyz ws://127.0.0.1:5500; 
        font-src 'none';
        frame-src 'none';
        object-src 'none';">

    <title>Mapa Redes Culturales - Artes para la Paz</title>
    
    <!-- MEJORA DE SEGURIDAD 2: Integridad de Subrecursos (SRI) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
          xintegrity="sha512-Rz1T9522Z1Xw23sD2d3iY6/QAGF3Kz34f1C6R3Tf11/9d5aCbevXQn/Hh/7WfIq0O/E247J3/2Vn1Q=="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
          xintegrity="sha512-H/0594411K3z7gMh52Zk11At/2Zc1pM99L/2P+p2r4n+t3KVJkE7T4k2v90I/k/t2Qe1T2l5OQyw=="
          crossorigin=""/>
          
    <style>
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #f0f0f0 0%, #e0e7ff 100%);
            color: #222;
            transition: background 0.5s, color 0.3s;
            display: flex; flex-direction: column;
        }
        body.dark-mode {
            background: linear-gradient(120deg, #1a1a1a 0%, #312e81 100%);
            color: #f0f0f0;
        }
        #main-header {
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            padding: 18px 24px;
            display: flex; align-items: center; justify-content: space-between;
            position: relative; z-index: 1500;
            transition: background 0.3s, color 0.3s;
        }
        #main-header h1 {
            font-size: 1.7em; margin: 0 40px; flex-grow: 1; text-align: center;
            letter-spacing: 1px;
        }
        .header-logo {
            height: 54px; width: auto; flex-shrink: 0;
            transition: filter 0.3s;
        }
        
        .header-logo-right {
            height: 68px; width: auto; flex-shrink: 0; margin-left: 12px; opacity: 0.95;
            transition: transform 0.18s, opacity 0.2s;
        }
        .header-logo-right:hover { transform: translateY(-2px); opacity: 1; }
        @media (max-width: 800px) {
            .header-logo-right { height: 50px; margin-left: 8px; }
        }
        #theme-toggle-btn {
            background: rgba(255,255,255,0.06); border: none; color: #ffffff;
            width: 44px; height: 36px; display:flex; align-items:center; justify-content:center;
            border-radius: 8px; cursor: pointer; transition: background 0.2s, transform 0.12s;
            padding: 6px;
        }
        #theme-toggle-btn:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
        body.dark-mode #main-header {
            background: rgba(30,41,59,0.95); color: #fff;
        }
        /* Estilo diurno: encabezado en amarillo quemado suave, panel sigue carmes√≠ claro */
        body:not(.dark-mode) #main-header {
            background: #ffdc4a;
            color: #111;
        }
        /* Forzar H1 blanco sobre el header */
        body:not(.dark-mode) #main-header h1 { color: #fff; }
        body:not(.dark-mode) #panel {
            background: #2b8ec6;
            color: #fff;
        }
        body.dark-mode #theme-toggle-btn { color: #ffffff; }
    #app-container { flex-grow: 1; position: relative; overflow: hidden; min-height: 0; }
        #panel {
            background: rgba(255,255,255,0.98);
            box-shadow: 2px 0 12px rgba(0,0,0,0.18);
            color: #222;
            position: absolute; top: 0; left: 0;
            width: 420px; height: 100%; padding: 24px 48px 20px 20px;
            display: flex; flex-direction: column; overflow-y: auto;
            z-index: 2000; transition: left 0.3s, background 0.3s, color 0.3s;
            box-sizing: border-box;
            animation: panelFadeIn 0.7s;
        }
        @keyframes panelFadeIn {
            from { opacity: 0; left: -420px; }
            to { opacity: 1; left: 0; }
        }
        body.dark-mode #panel {
            background: rgba(30,41,59,0.98); color: #f0f0f0;
        }
        #filters h2, #legend h2 {
            border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 10px; color: inherit;
        }
        body.dark-mode #filters h2, body.dark-mode #legend h2 {
            border-bottom: 1px solid #444;
        }
        #close-panel-btn {
            position: absolute; top: 10px; right: 18px;
            background: none; border: none; color: #888;
            font-size: 28px; font-weight: bold; cursor: pointer;
            transition: color 0.2s;
            z-index: 3000;
        }
        #close-panel-btn:hover { color: #6366f1; }
        .filter-option label {
            display: flex; align-items: center; cursor: pointer; padding: 6px 0;
            transition: background 0.2s;
        }
        .filter-option label:hover {
            background: #e0e7ff;
        }
        body.dark-mode .filter-option label:hover {
            background: #312e81;
        }
        #search-box {
            margin-bottom: 18px;
            display: flex; align-items: center;
            padding-right: 50px; /* espacio para el bot√≥n cerrar en mobile */
            position: relative; /* para posicionar el bot√≥n de borrar */
        }
        
    :root { --search-clear-w: 34px; --search-btn-w: 44px; --search-gap: 10px; --filters-blue: #51cafc; --panel-theme-purple: #7c3aed; }
        #search-input {
            
            width: calc(100% - var(--search-btn-w) - 5px);
            padding: 7px 12px; border-radius: 6px; border: 1px solid #6366f1;
            
            padding-right: 20px; /* Ajuste para mostrar el placeholder completo */
            font-size: 1em; outline: none; margin-right: 0;
            box-sizing: border-box; position: relative; z-index: 2500; background: #fff;
        }
        #search-input:focus {
            border-color: #fbbf24;
        }
        
        #search-btn {
            position: absolute; right: calc(var(--search-gap)); top: 50%; transform: translateY(-50%);
            background: var(--filters-blue); color: #fff; border: none; border-radius: 6px;
            width: var(--search-btn-w); height: 34px; cursor: pointer; font-size: 1em; z-index: 2750;
            display: inline-flex; align-items: center; justify-content: center;
            transition: background 0.18s, transform 0.12s;
        }
        #search-btn:hover { filter: brightness(0.95); transform: translateY(-50%) scale(1.02); }
        
        #search-suggestions {
            display: none; position: relative; width: 100%; margin-bottom: 8px; z-index: 2500;
            max-height: 260px; overflow-y: auto; border-radius: 8px;
            box-shadow: 0 8px 24px rgba(16,24,40,0.12);
        }
        .suggestion-item {
            padding: 10px 12px; background: rgba(255,255,255,0.98); cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.04);
            color: #111; display: block;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item:focus { background: #f3f4f6; outline: none; }
    .suggestion-item.highlight { background: #eef2ff; }
        body.dark-mode .suggestion-item { background: rgba(20,24,32,0.96); color: #fff; border-bottom: 1px solid rgba(255,255,255,0.03); }
        body.dark-mode .suggestion-item:hover, body.dark-mode .suggestion-item:focus { background: rgba(40,44,59,0.95); }
        
        #search-clear-btn {
            
            position: absolute; right: calc(var(--search-btn-w) + var(--search-gap) + 5px); top: 50%; transform: translateY(-50%);
            width: var(--search-clear-w); height: 28px; border-radius: 50%; border: 1px solid #d1d5db; background: #e5e7eb;
            display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 2800;
            font-size: 14px; color: #000; padding: 0; box-sizing: border-box; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        #search-clear-btn:hover { background: #d1d5db; }
        body.dark-mode #search-clear-btn { background: rgba(255,255,255,0.06); color: #fff; }
        
        #search-clear-btn.visible { display: flex !important; }
        #legend .legend-item {
            display: flex; align-items: center; margin-bottom: 10px;
            font-size: 1em;
        }
        .legend-logo {
            width: 26px; height: 26px; margin-right: 10px;
        }
        
        .filter-option.active { border-radius: 6px; }
        .filter-option .filter-btn { 
            display:flex; 
            align-items:center; 
            justify-content: space-between;
            gap:8px; 
            padding:6px 8px; 
            cursor:pointer; 
            background: transparent; 
            border: none; 
            width: 100%; 
            text-align: left; 
        }
        .filter-option .filter-btn:focus { outline: 2px solid #fbbf24; }
        .filter-btn.night-mode { opacity: 0.95; }
        .filter-btn.night-mode:active, .filter-option.active .filter-btn.night-mode { background: rgba(255,255,255,0.04); }
        .filter-btn div span { color: #111; }
        
        .filter-option.active .filter-btn div span { color: #111; }
        body.dark-mode .filter-option.active .filter-btn div span { color: #fff; }

        .network-count {
            padding: 3px 9px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            box-sizing: border-box;
        }

        body:not(.dark-mode) .network-count {
            background-color: var(--blue-dark);
            color: white;
        }

        body.dark-mode .network-count {
            background-color: var(--blue-pastel);
            color: var(--blue-dark);
        }

        .filters-card {
            background: rgba(255,255,255,0.96);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            margin-bottom: 12px;
        }
        
    #panel .filters-card h2 { margin: 0 0 8px 0; color: #111; font-size: 1.05em; font-weight: 700; }
    
    .filters-card { background: #51cafc; }
    body.dark-mode #panel .filters-card { background: rgba(20,24,32,0.82); box-shadow: 0 6px 18px rgba(0,0,0,0.45); }
    body.dark-mode #panel .filters-card h2 { color: #fff; }

        
        :root {
            --blue-pastel: #d7f0ff;
            --blue-dark: #063c6b;
        }
        .filters-card .filter-btn { background: transparent; border-radius: 8px; padding: 8px; display: flex; align-items: center; gap:8px; }
        .filters-card .filter-btn .legend-logo { filter: none; }
        
        body:not(.dark-mode) .filters-card .filter-btn div span { color: var(--blue-dark); }

        
        body:not(.dark-mode) .filters-card .filter-option.active .filter-btn { background: var(--blue-pastel); }
        body:not(.dark-mode) .filters-card .filter-option.active .filter-btn div span { color: var(--blue-dark); font-weight: 600; }

        
        body.dark-mode .filters-card .filter-btn div span { color: #ffffff; }
        body.dark-mode .filters-card .filter-option.active .filter-btn { background: var(--blue-pastel); }
        body.dark-mode .filters-card .filter-option.active .filter-btn div span { color: var(--blue-dark); font-weight: 700; }

        
        /* Se eliminan los fondos de colores espec√≠ficos para los botones activos en modo oscuro para unificar el estilo */
        #map-container {
            width: 100%; height: 100%; position: absolute; top: 0;
            transition: left 0.3s, width 0.3s;
        }
        #map { width: 100%; height: 100%; }
        
    #map.day-enhance { filter: saturate(1.15) contrast(1.05) hue-rotate(-6deg); }
    body.dark-mode #map { filter: grayscale(0.15) contrast(0.9) brightness(0.9); }
        /* Debug overlay */
        #debug-overlay {
            position: fixed; right: 12px; bottom: 12px; z-index: 99999;
            background: rgba(0,0,0,0.7); color: #fff; padding: 10px 12px; border-radius: 8px;
            font-size: 12px; max-width: 420px; box-shadow: 0 6px 24px rgba(0,0,0,0.4);
        }
        .panel-toggle-btn {
            position: absolute; top: 18px; left: 18px; z-index: 1000;
            background: #6366f1; color: #fff; border: none; border-radius: 6px;
            cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.18);
            font-size: 1.1em; padding: 8px 16px; transition: background 0.3s;
        }
        .panel-toggle-btn:hover { background: #fbbf24; color: #222; }
        /* Tooltip for header logos (positioned above each logo) */
        .header-tooltip {
            position: absolute; transform: translateY(-8px); z-index: 5000; background: rgba(0,0,0,0.85); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 13px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.12s, transform 0.12s;
        }
        .header-tooltip.show { opacity: 1; transform: translateY(-12px); }
        /* Panel theme toggle styles */
        .panel-theme-btn {
            background: var(--panel-theme-purple); border: 1px solid rgba(0,0,0,0.06); padding: 8px 10px; border-radius: 8px; cursor: pointer;
            color: #fff; display: inline-flex; align-items: center; justify-content: center;
        }
        body.dark-mode .panel-theme-btn { border-color: rgba(255,255,255,0.08); }
        .popup-content {
            max-width: 320px; font-size: 1em;
            animation: popupFadeIn 0.5s;
        }
        @keyframes popupFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .popup-content h5 { margin: 0 0 7px 0; color: #6366f1; font-size: 1.15em; }
        .popup-content p { margin: 3px 0; font-size: 0.98em; color: #555; }
        .popup-content strong { color: #222; }
        .leaflet-tooltip {
            background: rgba(99,102,241,0.85); color: #fff; border: 1px solid #6366f1;
            border-radius: 5px; padding: 6px; font-size: 1em;
        }
        .leaflet-marker-icon {
            /* sombra del √≠cono: m√°s intensa para separar mejor del fondo (80% opacity) */
            filter: drop-shadow(0px 4px 8px rgba(99,102,241,0.8));
            transition: filter 0.3s;
        }
        .leaflet-marker-icon:hover {
            filter: drop-shadow(0px 6px 12px rgba(251,191,36,0.8));
        }
        /* Estilos para clusters: color plano, n√∫mero en blanco, sin borde */
        .marker-cluster div {
            background: #cfe8ff; /* d√≠a: pastel azul por defecto */
            border-radius: 50%;
            width: 46px; height: 46px;
            display: flex; align-items: center; justify-content: center;
            border: none;
            box-shadow: 0 6px 18px rgba(0,0,0,0.28);
            color: #fff; font-weight: 700; font-size: 14px;
        }
        .marker-cluster span { line-height: 1; }
        /* Tonalidades por red (d√≠a) - colores planos, n√∫mero blanco */
        .marker-cluster.marker-cluster-hiphop div { background: #b91c1c; } /* carmes√≠ */
        .marker-cluster.marker-cluster-emergentes div { background: #059669; } /* verde */
        .marker-cluster.marker-cluster-juvenil div { background: #7c3aed; } /* morado */
        .marker-cluster.marker-cluster-mujeres div { background: #d946ef; } /* fucsia */
        /* Ajustes para clusters grandes */
        .marker-cluster .marker-cluster-1, .marker-cluster div.large { width: 56px; height: 56px; font-size: 16px; }

        /* Modo oscuro: colores complementarios y m√°s saturados */
        body.dark-mode .marker-cluster div { background: #23303a; color: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.45); }
        body.dark-mode .marker-cluster.marker-cluster-hiphop div { background: #ff6b6b; }
        body.dark-mode .marker-cluster.marker-cluster-emergentes div { background: #34d399; }
        body.dark-mode .marker-cluster.marker-cluster-juvenil div { background: #a78bfa; }
        body.dark-mode .marker-cluster.marker-cluster-mujeres div { background: #f472b6; } /* rosado */
        /* Accesibilidad */
        #main-header, #panel, #map-container, .panel-toggle-btn, #theme-toggle-btn {
            outline: none;
        }
        #main-header:focus, #panel:focus, #map-container:focus, .panel-toggle-btn:focus, #theme-toggle-btn:focus {
            box-shadow: 0 0 0 3px #fbbf24;
        }
        /* Tutorial Panel Styles */
        .tutorial-card {
            background: #eef2ff;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            margin-top: 20px;
            max-height: 240px; /* Altura m√°xima para activar el scroll */
            overflow-y: auto; /* Scroll vertical solo cuando sea necesario */
        }
        body:not(.dark-mode) .tutorial-card {
            color: #3730a3; /* Violeta oscuro para legibilidad en modo d√≠a */
        }
        body.dark-mode .tutorial-card {
            background: rgba(40,44,59,0.95);
        }
        .tutorial-card h2 {
            margin: 0 0 10px 0;
            color: #111;
            font-size: 1.05em;
            font-weight: 700;
        }
        body.dark-mode .tutorial-card h2 {
            color: #fff;
        }
        .tutorial-card ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .tutorial-card li {
            font-size: 0.85em; /* Letra m√°s peque√±a */
            line-height: 1.5;
            margin-bottom: 10px;
            padding-right: 8px; /* Espacio para la barra de scroll */
        }
        .tutorial-card li:last-child {
            margin-bottom: 0;
        }
        .tutorial-card strong {
            color: #6366f1;
        }
        body.dark-mode .tutorial-card strong {
            color: #a78bfa;
        }

    @media (max-width: 800px) {
            #main-header { padding: 12px 10px; }
            #main-header h1 { font-size: 1em; margin: 0 10px; }
            .header-logo { height: 40px; }
            /* En m√≥vil el panel ocupa 80% del ancho para dejar 20% del mapa visible detr√°s */
            #panel { width: 80vw; left: -80vw; padding-right: 18px; box-shadow: 2px 0 18px rgba(0,0,0,0.22); }
            #panel.show { left: 0; }
            #map-container { left: 0; width: 100vw; }
            #desktop-panel-toggle { display: none; }
            #mobile-panel-toggle { display: block; width: 44px; height: 44px; font-size: 26px; padding: 0; text-align: center;}
            /* move close X more to the corner on mobile and make it white to avoid overlap */
            #close-panel-btn { right: 1px; top: 8px; color: #fff; z-index: 3000; }
            
            /* Ajustes para el panel de tutorial en m√≥vil */
            .tutorial-card {
                max-height: none; /* Permitir que se expanda completamente */
                overflow-y: visible; /* Desactivar el scroll interno para que el panel principal se desplace */
            }
        }
        @media (min-width: 801px) {
            #panel { left: 0; }
            #map-container { left: 420px; width: calc(100% - 420px); }
            #app-container.panel-collapsed #panel { left: -420px; }
            #app-container.panel-collapsed #map-container { left: 0; width: 100%; }
            #desktop-panel-toggle { display: block; padding: 10px 16px; }
            #mobile-panel-toggle { display: none; }
            #close-panel-btn { display: none; }
            
            /* Nuevas reglas para el encabezado en escritorio */
            #main-header {
                position: relative;
                padding-left: 420px;
                box-sizing: border-box;
            }
            #main-header .header-logo-link:first-child {
                position: absolute;
                left: 24px;
                top: 50%;
                transform: translateY(-50%);
            }
            #main-header h1 {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div id="main-header" tabindex="0">
        <a id="link-artes" class="header-logo-link" href="https://artesparalapaz.mincultura.gov.co/Paginas/index.aspx" target="_blank" rel="noopener noreferrer" title="Volver a la p√°gina de Artes para la Paz">
            <img src="https://raw.githubusercontent.com/felipecotero/ARTESPARALAPAZ/main/APLP%20MORADO.png?v=2" alt="Logo Artes para la Paz" class="header-logo">
        </a>
    <h1>Redes y Procesos Art√≠sticos y Comunitarios &bull; Artes para la Paz</h1>
        <a id="link-culturas" class="header-logo-link" href="https://www.mincultura.gov.co/" target="_blank" rel="noopener noreferrer" title="Ir al Ministerio de las Culturas, las Artes y los Saberes de Colombia">
            <img src="https://raw.githubusercontent.com/felipecotero/ARTESPARALAPAZ/main/GRIS_CULTURAS.png?v=2" alt="Logo Culturas" class="header-logo-right" />
        </a>
    </div>
    <div id="app-container">
        <div id="panel" tabindex="0">
            <button id="close-panel-btn" title="Cerrar panel" tabindex="0">&times;</button>
            <div id="search-box">
                <input id="search-input" type="text" placeholder="Buscar por organizaci√≥n, proyecto o ciudad..." aria-label="Buscar" tabindex="0">
                <button id="search-btn" title="Buscar" tabindex="0">üîç</button>
                <button id="search-clear-btn" title="Borrar b√∫squeda" aria-label="Borrar b√∫squeda" tabindex="0">‚úï</button>
            </div>
            <div id="search-suggestions" role="listbox" aria-label="Sugerencias de b√∫squeda"></div>
            <div id="filters">
                <div class="filters-card">
                    <h2>Convenciones y Filtros</h2>
                    <!-- Las opciones y logos se generan din√°micamente en JS para respetar logoUrls y fallback -->
                    <div id="filters-list"></div>
                        <!-- Eliminado bot√≥n de compatibilidad y resultados -->
                    <!-- Theme toggle inside filters card (bottom-left) -->
                    <div id="panel-theme-row" style="margin-top:10px; display:flex; align-items:center;">
                        <button id="panel-theme-toggle-btn" class="panel-theme-btn" title="Cambiar modo claro/oscuro" aria-pressed="false" style="margin-left:0;">üåô</button>
                    </div>
                </div>
            </div>
            <div id="tutorial-panel" class="tutorial-card">
                <h2>¬øC√≥mo usar el mapa?</h2>
                <ul>
                    <li><strong>Explora:</strong> Ac√©rcate en el mapa para ver los puntos individuales de cada organizaci√≥n. Los grupos de puntos (clusters) se abrir√°n al hacer zoom.</li>
                    <li><strong>Busca:</strong> Usa el campo de b√∫squeda para encontrar organizaciones por su nombre, el nombre del proyecto o la ciudad.</li>
                    <li><strong>Reinicia:</strong> Al borrar el texto del campo de b√∫squeda, el mapa volver√° a la vista inicial de Colombia, respetando los filtros que hayas seleccionado.</li>
                </ul>
            </div>
        </div>
        <div id="map-container" tabindex="0">
            <button id="mobile-panel-toggle" class="panel-toggle-btn" title="Abrir filtros" tabindex="0">‚ò∞</button>
            <button id="desktop-panel-toggle" class="panel-toggle-btn" title="Abrir filtros" tabindex="0">Filtros</button>
            <div id="map"></div>
        </div>
    </div>
    <!-- Debug overlay removed for production build -->
    <!-- header tooltips will be created dynamically by JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="" defer></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
            xintegrity="sha512-QcKOeNZe6K+Ie3LPSLhBmfv0oKj+M/aRClLqlbSBcMRvNf2vS+uS1JzM/2gR6fF2FTr2PCl2XhYsDjpbWGNQ5w=="
            crossorigin="" defer></script>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
            const PREVIEW_ASSETS = false; 
            const FORCE_USE_PRODUCTION_LOGOS = true;
            function svgDataUri(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
            const previewLogos = {
                aplp: svgDataUri(`<svg xmlns='http://www.w3.org/2000/svg' width='160' height='54' viewBox='0 0 160 54'><rect width='100%' height='100%' rx='8' fill='%237c3aed'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='18'>ARTES</text></svg>`),
                culturas: svgDataUri(`<svg xmlns='http://www.w3.org/2000/svg' width='216' height='68' viewBox='0 0 216 68'><rect width='100%' height='100%' rx='8' fill='%237c3aed'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='16'>CULTURAS</text></svg>`),
                hiphop: svgDataUri(`<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'><rect width='80' height='80' rx='12' fill='%23b91c1c'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='12'>HIPHOP</text></svg>`),
                emergentes: svgDataUri(`<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'><rect width='80' height='80' rx='12' fill='%23059669'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='10'>EMERGENTES</text></svg>`),
                juvenil: svgDataUri(`<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'><rect width='80' height='80' rx='12' fill='%237c3aed'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='12'>JUVENIL</text></svg>`)
            };
            function debugMsg(msg){ /* no-op for production; keep for dev toggling */ }
            debugMsg('DOMContentLoaded - esperando Leaflet...');
            window.addEventListener('unhandledrejection', function(evt){
                try{
                    const reason = evt.reason && (evt.reason.message || evt.reason.toString()) || String(evt.reason);
                    console.warn('Captured unhandledrejection:', evt.reason);
                    debugMsg('UnhandledRejection: ' + reason + '\n(Revisa extensiones del navegador o scripts externos)');
                    evt.preventDefault();
                }catch(e){ console.warn('Error handling unhandledrejection', e); }
            });
            function showStatus(){
            const mapEl = document.getElementById('map');
            const rect = mapEl.getBoundingClientRect();
            const clusterAvailable = (typeof L !== 'undefined' && typeof L.markerClusterGroup === 'function');
            debugMsg(`L definido: ${typeof L !== 'undefined'}\nmarkerCluster disponible: ${clusterAvailable}\nmap size: ${Math.round(rect.width)} x ${Math.round(rect.height)}\nwindow: ${window.innerWidth} x ${window.innerHeight}`);
        }
            let tries = 0;
            const tryInit = setInterval(()=>{
                tries++;
                if(typeof L !== 'undefined' || tries > 20){
                    clearInterval(tryInit);
                    if(typeof L === 'undefined'){
                        debugMsg('Leaflet no cargado. Comprueba conexi√≥n o CDN.');
                        console.error('Leaflet no cargado');
                        return;
                    }
                                debugMsg('Leaflet cargado. Comprobando logos y preparando interfaz...');
                                showStatus();
                                    preloadLogos().then(result => {
                        for (const k in result) {
                            if (result[k] === 'failed' || result[k] === 'unknown') {
                                logoUrls[k] = placeholderLogo;
                            }
                        }
                        renderFilters();
                        debugMsg('Logos comprobados. Inicializando mapa...');
                        initMap();
                    }).catch(e => { console.warn('preloadLogos error', e); renderFilters(); initMap(); });
                }
            }, 200);
        const appContainer = document.getElementById('app-container');
        const panel = document.getElementById('panel');
        const mobileToggleButton = document.getElementById('mobile-panel-toggle');
        const desktopToggleButton = document.getElementById('desktop-panel-toggle');
        const closeButton = document.getElementById('close-panel-btn');
    // header theme toggle removed; panel toggle used instead
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

    const markersById = new Map();

        const organizations = [
            {network: 'Red Hip Hop', name: 'FUNDACION CULTURAL Y SOCIAL 5TA CON 5TA CREW', project: 'Proceso pedag√≥gico y art√≠stico', dates: 'Hasta 08/11/25', lat: 7.907, lng: -72.504, city: 'C√∫cuta'},
            {network: 'Red Hip Hop', name: 'FUNDACION SURPRISE CITY', project: 'Talleres en Jamondino y c√°rcel', dates: 'Hasta 01/11/25', lat: 1.213, lng: -77.281, city: 'Pasto'},
            {network: 'Red Hip Hop', name: 'FUNDACION HIP HOP PE√ëA', project: 'Encuentros Formativos y Festival', dates: 'Hasta 16/11/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Red Hip Hop', name: 'FUNDACION CULTURAL PAZ Y TERRITORIO', project: 'Sesiones formativas (MC, DJ, etc.)', dates: '01/11/25 - 20/11/25', lat: 4.438, lng: -75.232, city: 'Ibagu√©'},
            {network: 'Red Hip Hop', name: 'CORPORACION CASA KOLACHO', project: 'Festival Manifiesto Fest', dates: '15/11/25 - 29/11/25', lat: 6.244, lng: -75.574, city: 'Medell√≠n'},
            {network: 'Red Hip Hop', name: 'ASOCIACION RAPJUDESCO', project: 'Encuentros formativos y Festival', dates: 'Hasta 23/11/25', lat: 4.711, lng: -74.072, city: 'Bogot√° D.C.'},
            {network: 'Red Hip Hop', name: 'FUNDACION EL CIRCULO HIP HOP', project: 'Talleres y Festival LIL CONCEP', dates: 'Hasta 16/11/25', lat: 4.711, lng: -74.072, city: 'Bogot√° D.C.'},
            {network: 'Red Hip Hop', name: 'FUNDACION TURA HIP HOP', project: 'T√©cnicas de composici√≥n l√≠rica', dates: '15/10/25 - 05/11/25', lat: 3.877, lng: -77.025, city: 'Buenaventura'},
            {network: 'Red Hip Hop', name: 'CASA DEL BARDO', project: 'Circulaci√≥n de Artistas', dates: '20/11/25 - 27/11/25', lat: 6.244, lng: -75.574, city: 'Medell√≠n'},
            {network: 'Red Hip Hop', name: 'MONTA√ëA RECORDS', project: 'Talleres y Festival Campesino', dates: 'Hasta 05/11/25', lat: 8.237, lng: -73.355, city: 'Oca√±a'},
            {network: 'Red Hip Hop', name: 'EXPRESION TEJIDA Y NEWPAPER', project: 'Encuentro Nacional de Hip Hop', dates: 'Hasta 18/10/25', lat: 10.393, lng: -75.482, city: 'Cartagena'},
            {network: 'Red Hip Hop', name: 'FUNDACION HIP HOP IPIALES', project: 'Formaci√≥n y Festival Binacional', dates: 'Hasta 17/11/25', lat: 0.828, lng: -77.641, city: 'Ipiales'},
            {network: 'Red Hip Hop', name: 'CORPORACION ARTES URBANAS CASA BEAT', project: 'Talleres de Formaci√≥n', dates: 'Hasta 06/10/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Red Hip Hop', name: 'ASOSACION HIP HOP POR NUESTRA TIERRA', project: 'Fortalecimiento y Festival COMPAS', dates: 'Hasta 15/11/25', lat: 5.714, lng: -72.933, city: 'Sogamoso'},
            {network: 'Red Hip Hop', name: 'COLECTIVO HIP HOP POR LA VIDA', project: 'Festival Hip Hop por la Vida', dates: 'Hasta 25/09/25', lat: 5.068, lng: -75.517, city: 'Manizales'},
            {network: 'Red Hip Hop', name: 'LA CASITA DE COLORES JUNTA COMUNAL AGUA BONITA', project: 'Festival Georgina Ortiz', dates: 'Hasta 21/09/25', lat: 3.370, lng: -73.870, city: 'Vista Hermosa'},
            {network: 'Organizaciones Emergentes', name: 'Fundaci√≥n Cuna de Acordeones', project: 'Festival Cuna de Acordeones', dates: 'Hasta 20/09/25', lat: 10.609, lng: -72.981, city: 'Villanueva'},
            {network: 'Organizaciones Emergentes', name: 'Fundaci√≥n Sociocultural La Nana', project: 'XXVIII Festival Regional de Teatro', dates: 'Hasta 20/09/25', lat: 10.518, lng: -74.195, city: 'Plato'},
            {network: 'Organizaciones Emergentes', name: 'ASOPAMURIMAJSA', project: 'Encuentro de intercambio artesanal', dates: 'Hasta 22/09/25', lat: 2.572, lng: -72.645, city: 'Mit√∫'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACION FESTIVAL DE CINE VERDE', project: '15¬∞ Festival de Cine Verde de Barichara', dates: 'Hasta 28/09/25', lat: 6.634, lng: -73.223, city: 'Barichara'},
            {network: 'Organizaciones Emergentes', name: 'ASOMAUCOWOT', project: 'Revitalizaci√≥n de Saberes Ancestrales', dates: 'Hasta 20/09/25', lat: 2.572, lng: -72.645, city: 'Mit√∫'},
            {network: 'Organizaciones Emergentes', name: 'Fundaci√≥n La Concepci√≥n', project: 'VIII ENCUENTRO NACIONAL DE SEXTETO', dates: 'Hasta 19/09/25', lat: 8.761, lng: -76.529, city: 'Mo√±itos'},
            {network: 'Organizaciones Emergentes', name: 'Corporaci√≥n Sin Fronteras', project: 'BARRANCABERMEJA LE CANTA A LA PAZ', dates: 'Hasta 15/11/25', lat: 3.900, lng: -76.298, city: 'Guadalajara de Buga'},
            {network: 'Organizaciones Emergentes', name: 'Corporaci√≥n CORPACOROS', project: '30o. Encuentro de M√∫sica Coral', dates: '01/10/25 - 05/10/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Organizaciones Emergentes', name: 'Corporaci√≥n CORARTE', project: 'Armon√≠as de Buga', dates: 'Hasta 15/11/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Organizaciones Emergentes', name: 'Fundaci√≥n Un Mar de Voces', project: 'ESCUELA CORAL UN MAR DE VOCES', dates: 'Hasta 22/11/25', lat: 11.000, lng: -74.958, city: 'Galapa'},
            {network: 'Organizaciones Emergentes', name: 'Coral Santa Mar√≠a', project: 'CORO A LA PLAZA', dates: 'Hasta 15/11/25', lat: 5.068, lng: -75.517, city: 'Manizales'},
            {network: 'Organizaciones Emergentes', name: 'Fundaci√≥n Arte y Parte Juli√°n Rodr√≠guez', project: 'Espacios formativos', dates: 'Hasta 15/11/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Organizaciones Emergentes', name: 'Fundaci√≥n Afroresilientes Colombianos', project: 'Espacios formativos Danza y M√∫sica', dates: 'Hasta 15/11/25', lat: 11.240, lng: -74.211, city: 'Santa Marta'},
            
            // Nuevas organizaciones emergentes
            {network: 'Organizaciones Emergentes', name: 'CORPORACI√ìN ARTE Y POES√çA PROMETEO', project: 'PEDAGOG√çA POETICA PARA LA PAZ', dates: '05/07/25 - 12/07/25', lat: 6.244, lng: -75.581, city: 'Medell√≠n'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN MUJERES INDEPENDIENTES Y EMPRENDEDORAS MIEN', project: 'En definici√≥n', dates: 'Por definir', lat: 4.620, lng: -74.172, city: 'Guti√©rrez'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN UNIDOS POR EL DESARROLLO COMUNITARIO', project: 'En definici√≥n', dates: 'Por definir', lat: 9.340, lng: -75.837, city: 'San Pelayo'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN IDENTIDAD DESPIERTA DOUGLAS CASTELLANOS', project: 'En definici√≥n', dates: 'Por definir', lat: 11.544, lng: -72.907, city: 'Riohacha'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN PAZ Y RECONCILIACI√ìN PARES', project: 'En definici√≥n', dates: 'Por definir', lat: 10.588, lng: -74.386, city: 'Aracataca'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN ACADEMICA DE M√öSICA CINTEMPOR√ÅNEA Y SOCIAL DECUPLUM', project: 'En definici√≥n', dates: 'Por definir', lat: 10.464, lng: -73.253, city: 'Valledupar'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN PARA EL DESARROLLO DR√ÅMATICO Y ARTISTICO DEL MAGDALENA', project: 'En definici√≥n', dates: 'Por definir', lat: 11.240, lng: -74.211, city: 'Santa Marta'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN CARMEN MANTILLA', project: 'En definici√≥n', dates: 'Por definir', lat: 10.518, lng: -74.795, city: 'El Plato'},
            {network: 'Organizaciones Emergentes', name: 'ASOCIACI√ìN DE CABILDOS IND√çGENAS ZONA DE IPIALES', project: 'En definici√≥n', dates: 'Por definir', lat: 0.828, lng: -77.641, city: 'Ipiales'},
            {network: 'Organizaciones Emergentes', name: 'CORPORACI√ìN PRIVADA DE BENEFICIO SOCIAL L&M', project: 'En definici√≥n', dates: 'Por definir', lat: 5.784, lng: -73.684, city: 'Paipa'},
            {network: 'Organizaciones Emergentes', name: 'MARCASHI GROUP SAS', project: 'En definici√≥n', dates: 'Por definir', lat: 4.711, lng: -74.072, city: 'Bogot√°'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN TIERRA PAZIFICA', project: 'En definici√≥n', dates: 'Por definir', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Organizaciones Emergentes', name: 'CULTURA NATIVA SAS', project: 'En definici√≥n', dates: 'Por definir', lat: 4.711, lng: -74.072, city: 'Bogot√°'},
            {network: 'Organizaciones Emergentes', name: 'CORPORACI√ìN PARA LA PROMOCI√ìN DE LAS ARTES Y LAS LETRAS CORPOULRIKA', project: 'En definici√≥n', dates: 'Por definir', lat: 4.711, lng: -74.072, city: 'Bogot√°'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN CULTURAL PARA LA TRANSFORMACI√ìN SOCIAL', project: 'En definici√≥n', dates: 'Por definir', lat: 7.065, lng: -73.854, city: 'Barrancabermeja'},
            {network: 'Organizaciones Emergentes', name: 'CORPORACI√ìN LA ESQUINA DEL BARRIO', project: 'En definici√≥n', dates: 'Por definir', lat: 4.439, lng: -75.232, city: 'Ibagu√©'},
            {network: 'Organizaciones Emergentes', name: 'FUNDACI√ìN LA CONCEPCI√ìN', project: 'En definici√≥n', dates: 'Por definir', lat: 8.878, lng: -76.111, city: 'San Juan de Urab√°'},
            {network: 'Organizaciones Emergentes', name: 'ASOCIACI√ìN VICTIMAS N√öCLEO SANTIAGO PEREZ', project: 'En definici√≥n', dates: 'Por definir', lat: 3.618, lng: -75.390, city: 'Ataco'},
            {network: 'Organizaciones Emergentes', name: 'CENTRO PERIFERIA', project: 'En definici√≥n', dates: 'Por definir', lat: 4.711, lng: -74.072, city: 'Bogot√°'},
            
            {network: 'Red Intercultural Juvenil', name: 'ASOCIACION RESONANCIA MEDIOS ARTISTICOS', project: 'Mapeo y Redes que Fluyen', dates: 'Hasta 08/11/25', lat: 4.85, lng: -74.05, city: 'Ch√≠a'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION CULTURAL FAHRENHEIT 451', project: 'Desarrollando competencias ciudadanas', dates: 'Hasta 25/11/25', lat: 4.858, lng: -74.033, city: 'Ch√≠a'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION JUVENIL INFLUENCERS ETNICOS', project: 'ESCUELA DE FORMACION AUDIOVISUAL', dates: 'Hasta 04/11/25', lat: 10.297, lng: -75.122, city: 'San Basilio de Palenque'},
            {network: 'Red Intercultural Juvenil', name: 'AMBIENTALISTAS DE CORAZ√ìN', project: 'FESTIVAL BIOCULTURAL ITINERANTE', dates: 'Hasta 07/11/25', lat: 4.966, lng: -73.965, city: 'La Calera'},
            {network: 'Red Intercultural Juvenil', name: 'FUNDACI√ìN RIMARTE', project: 'Mi Primera Canci√≥n', dates: 'Oct-Nov 2025', lat: 3.40, lng: -76.50, city: 'Cali'},
            {network: 'Red Intercultural Juvenil', name: 'FUNDACI√ìN "ALAS Y RA√çCES"', project: 'Muralismo La Belleza de Colombia', dates: 'Hasta 07/11/25', lat: 6.037, lng: -73.743, city: 'Cimitarra'},
            {network: 'Red Intercultural Juvenil', name: 'FUNDACION NUEVO ESTILO DANCE', project: 'RUTA DEL RITMO', dates: 'Hasta 22/11/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Red Intercultural Juvenil', name: 'Guaque/Territorialidades S.A.S', project: 'QUYCAGUA: El Tejido de los Pueblos', dates: 'Hasta 16/11/25', lat: 4.908, lng: -73.938, city: 'Guatavita'},
            {network: 'Red Intercultural Juvenil', name: 'FUNDACION FUTURO DE LA GUAJIRA', project: 'WAK√úAIPPA CULTURA POPULAR', dates: 'Hasta 08/11/25', lat: 11.35, lng: -72.90, city: 'Riohacha'},
            {network: 'Red Intercultural Juvenil', name: 'J√≥venes Creadores del Choc√≥', project: 'Saberes que transforman', dates: 'Hasta 24/10/25', lat: 5.694, lng: -76.661, city: 'Quibd√≥'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACI√ìN C√ìDIGO ESTILO CREW', project: 'EL PARCHE JUVENIL DEL QUINDIO', dates: '04/10/25 - 08/11/25', lat: 4.533, lng: -75.681, city: 'Armenia'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACI√ìN RED CEPELA', project: 'Circuito Cultural Danza Teatro', dates: 'Hasta 30/10/25', lat: 7.243, lng: -76.435, city: 'Mutat√°'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION REY DE LA SELVA', project: 'FESTIVAL RUGIDO SOCIAL', dates: '01/10/25 - 15/11/25', lat: 5.694, lng: -76.661, city: 'Quibd√≥'},
            {network: 'Red Intercultural Juvenil', name: 'Ecosistemas Culturales', project: 'Agenda de Impulso a las Artes', dates: 'Hasta 28/11/25', lat: 10.612, lng: -75.146, city: 'Luruaco'},
            {network: 'Red Intercultural Juvenil', name: 'The Giants Community', project: 'Festival Juvenil de Arte Urbano', dates: '18/11/25 - 23/11/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Red Intercultural Juvenil', name: 'Corporaci√≥n Emergiendo', project: 'NARRATIVAS URBANAS MANIZALES', dates: '04/10/25 - 26/10/25', lat: 5.068, lng: -75.517, city: 'Manizales'},
            {network: 'Red Intercultural Juvenil', name: 'Corporacion La Tigra', project: 'Caravana Cuando el R√≠o Suena', dates: 'Hasta 12/10/25', lat: 6.988, lng: -73.048, city: 'Piedecuesta'},
            {network: 'Red Intercultural Juvenil', name: 'Red de danzantes', project: 'Janshan Por la Vida', dates: 'Hasta 08/11/25', lat: 1.205, lng: -76.920, city: 'Mocoa'},
            {network: 'Red Intercultural Juvenil', name: 'KUAGRO RI JIP JOP PALENGE', project: 'Fortalecimiento Lengua Palenquera', dates: 'Oct-Nov 2025', lat: 10.297, lng: -75.122, city: 'San Basilio de Palenque'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION YUKUTA SONIDO NATIVO', project: 'M√∫sica, canto y Festival Yakar√©', dates: '02/10/25 - 10/11/25', lat: 3.865, lng: -67.923, city: 'In√≠rida'},
            {network: 'Red Intercultural Juvenil', name: 'Vida-Paz', project: 'CULTURA Y BIODIVERSIDAD', dates: 'Hasta 21/11/25', lat: 2.572, lng: -72.645, city: 'Mit√∫'},
            {network: 'Red Intercultural Juvenil', name: 'ASOCIACION ARTE SHEMBASENG', project: 'El arte urbano como herramienta para la creatividad', dates: 'Sept-Oct 2025', lat: 1.205, lng: -76.920, city: 'Mocoa'},
            {network: 'Red Intercultural Juvenil', name: 'Comunicaci√≥n Visual sin Fronteras Amazonas', project: 'cosmovisi√≥n de la etnia Maguta', dates: '02/11/25 - 28/11/25', lat: -3.771, lng: -70.383, city: 'Puerto Nari√±o'},
            {network: 'Red Intercultural Juvenil', name: 'D Three Studio Alternativo', project: 'Lenguajes Entrelazados (Quinta Edici√≥n: El Recreo)', dates: 'Oct-Nov 2025', lat: 4.711, lng: -74.072, city: 'Bogot√° D.C.'},
            {network: 'Red Intercultural Juvenil', name: 'FUNDACI√ìN MANGLARIA DIVERSA', project: 'Red de Ritmos para la Paz: Juventudes Tejiendo Identidad y Convivencia', dates: '01/10/2025 - 31/10/2025', lat: 1.805, lng: -78.764, city: 'Tumaco'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION ARTISTICA RITMO EXTREMO REX - MEDANCE MD S.A.S.', project: 'JUVENTUDES EN MOVIMIENTO', dates: 'Oct-Nov 2025', lat: 6.244, lng: -75.574, city: 'Medell√≠n'},
            {network: 'Red Intercultural Juvenil', name: 'ESCUELA DE MUSICA LA ESFERA - FUNDACI√ìN MUSIQULTURA', project: 'RESCATANDO LO NUESTRO', dates: '15/10/2025 - 30/11/2025', lat: 12.5847, lng: -81.7006, city: 'San Andr√©s Isla'},
            {network: 'Red Intercultural Juvenil', name: 'Corporaci√≥n Juvenil Arreglando el Pa√≠s - Nodo Macizo Arte y Cultura', project: 'Vientos del Macizo ‚ÄúEscuela de m√∫sica tradicional"', dates: '15/10/2025 - 21/11/2025', lat: 1.853, lng: -76.048, city: 'Pitalito'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACI√ìN KHUYAY FESTIVAL PEREIRA QUERENDONA', project: 'Ciclo de formaci√≥n, murales y foro', dates: 'Oct-Nov 2025', lat: 4.813, lng: -75.694, city: 'Pereira'},
            
            // Nuevas organizaciones Red Intercultural Juvenil
            {network: 'Red Intercultural Juvenil', name: 'FUNDACION PACIFICA CULTURAL', project: 'Laboratorios de creaci√≥n', dates: '03/11/25 - 24/11/25', lat: 3.451, lng: -76.532, city: 'Cali'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION CALINA CUMBAY', project: 'Talleres de Danza, Circo y Biocultura', dates: '13/10/25 - 29/11/25', lat: 5.030, lng: -74.883, city: 'Armero-Guayabal'},
            {network: 'Red Intercultural Juvenil', name: 'LINDEROS DE PAZ', project: 'Sesiones Formativas Danza y M√∫sica', dates: '13/10/25 - 09/11/25', lat: 4.711, lng: -74.072, city: 'Bogot√°'},
            {network: 'Red Intercultural Juvenil', name: 'ASOCIACION PARCHEMOS POR YACOPI', project: 'Laboratorio de muralismo y Sancocho Master', dates: '23/10/25 - 02/11/25', lat: 5.456, lng: -74.348, city: 'Yacop√≠'},
            {network: 'Red Intercultural Juvenil', name: 'ASOCIACION DE AUTORIDADES INDIGENAS ATICOYA', project: 'Talleres de historia Ticuna y danza', dates: '29/10/25 - 28/11/25', lat: -3.771, lng: -70.383, city: 'Puerto Nari√±o'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACI√ìN ART√çSTICA Y CULTURAL HUELLAS DE MI TIERRA', project: 'Barirock Festival 2025', dates: '10/11/25 - 30/11/25', lat: 7.894, lng: -72.508, city: 'C√∫cuta'},
            {network: 'Red Intercultural Juvenil', name: 'FUNDACI√ìN AMAHIA La Enredadera Colectiva', project: 'Talleres de arcilla, comunicaci√≥n y muralismo', dates: 'Oct-Nov 2025', lat: 5.714, lng: -72.933, city: 'Sogamoso'},
            {network: 'Red Intercultural Juvenil', name: 'CORPORACION CULTURAL Y ARTISTICA ELEMENTS', project: 'Actividades interdisciplinares', dates: 'Nov 2025', lat: 6.244, lng: -75.581, city: 'Medell√≠n'},
            {network: 'Red Intercultural Juvenil', name: 'DINAST√çA NEGRA', project: 'Talleres de Danza', dates: 'Nov 2025', lat: 8.878, lng: -76.111, city: 'San Juan de Urab√°'},
            
            // Red de Mujeres - Nuevas organizaciones
            {network: 'Red de Mujeres', name: 'Chaib√°, Fundaci√≥n para el desarrollo humano', project: 'Festival Tit√∫a, tejiendo memorias y saberes', dates: '03/11/25 - 09/11/25', lat: 5.103, lng: -73.800, city: 'Suesca'},
            {network: 'Red de Mujeres', name: 'FUNDACION CULTURAL KYNZA XIE', project: 'Escuela de Saberes Hilos de Luna_al AULA', dates: '21/11/25 - 22/11/25', lat: 4.858, lng: -74.033, city: 'Ch√≠a'},
            {network: 'Red de Mujeres', name: 'Asociaci√≥n de mujeres Wiwa Abudzibu Asomuwadzi', project: 'Encuentro intercultural de mujeres ind√≠genas Wiwa', dates: '08/11/25', lat: 11.240, lng: -74.211, city: 'Santa Marta'},
            {network: 'Red de Mujeres', name: 'ORGANIZACION DE MUJERES VICTIMAS DEL RIO IRO (ORVIEN)', project: 'RESCATE TRADICIONES Y COSTUMBRES ANSESTRALES', dates: '03/11/25 - 23/11/25', lat: 5.694, lng: -76.661, city: 'R√≠o Ir√≥'},
            {network: 'Red de Mujeres', name: 'FUNDACION MICELIO TEJIENDO SABERES', project: 'I VERSION DEL FESTIVAL ANCESTRAL DE LA TRADICION ZENU', dates: '15/11/25 - 16/11/25', lat: 9.320, lng: -75.295, city: 'Corozal'},
            {network: 'Red de Mujeres', name: 'Asociaci√≥n COMPA√ë√çA AM√âRICA DANZA', project: 'Danza, Movimientos y Emociones de Mujeres para Mujeres', dates: '10/11/25 - 16/11/25', lat: 4.588, lng: -74.208, city: 'Soacha'},
            {network: 'Red de Mujeres', name: 'FUNDACION ACADEMICA DE MUSICA CONTEMPORANEA Y SOCIAL DECUPLUM', project: 'ENCUENTRO DE VOCES Y ACORDEONES FEMENINO - EVAFE 2025', dates: '29/09/25 - 05/10/25', lat: 10.464, lng: -73.253, city: 'Valledupar'}
        ];
        // A√±adida la nueva red en el orden solicitado
        const logoUrls = {
            'Red Hip Hop': 'https://raw.githubusercontent.com/felipecotero/ARTESPARALAPAZ/main/REDDEHIPHOP.png',
            'Organizaciones Emergentes': 'https://raw.githubusercontent.com/felipecotero/ARTESPARALAPAZ/main/ORGANIZACIONES%20EMERGENTES.png',
            'Red Intercultural Juvenil': 'https://raw.githubusercontent.com/felipecotero/ARTESPARALAPAZ/main/RED%20JUVENIL.png',
            'Red de Mujeres': 'https://raw.githubusercontent.com/felipecotero/ARTESPARALAPAZ/main/ORGANIZACIONES%20DE%20MUJERES.png'
        };
        const placeholderLogo = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'><rect width='80' height='80' rx='12' fill='%2371717a'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='18' font-family='Arial'>LOGO</text></svg>";
        const loadedLogos = {};
        function preloadLogos(timeout = 2500){
            const keys = Object.keys(logoUrls);
            if (!keys.length) return Promise.resolve(loadedLogos);
            const host = window.location.hostname;
            const isLocal = host === '127.0.0.1' || host === 'localhost' || window.location.protocol === 'file:';
            // Desactivado temporalmente para forzar carga de logos reales
            // if (isLocal && !FORCE_USE_PRODUCTION_LOGOS) {
            //     keys.forEach(k => { loadedLogos[k] = 'skipped-local'; logoUrls[k] = placeholderLogo; });
            //     debugMsg('Entorno local detectado: saltando carga remota de logos y usando placeholder');
            //     return Promise.resolve(loadedLogos);
            // } else if (isLocal && FORCE_USE_PRODUCTION_LOGOS) {
            //     debugMsg('Entorno local detectado: intentando cargar logos remotos (FORCE_USE_PRODUCTION_LOGOS=true)');
            // }
            debugMsg('Forzando carga de logos remotos desde GitHub');
            return new Promise(resolve => {
                let remaining = keys.length;
                keys.forEach(key => {
                    const img = new Image();
                    img.onload = () => { loadedLogos[key] = 'ok'; remaining--; if (remaining === 0) resolve(loadedLogos); };
                    img.onerror = () => { loadedLogos[key] = 'failed'; remaining--; if (remaining === 0) resolve(loadedLogos); };
                    img.src = logoUrls[key];
                    setTimeout(() => { if (!loadedLogos[key]) { loadedLogos[key] = 'unknown'; remaining--; if (remaining === 0) resolve(loadedLogos); } }, timeout);
                });
            });
        }
        try {
            if (typeof PREVIEW_ASSETS !== 'undefined' && PREVIEW_ASSETS) {
                logoUrls['Red Hip Hop'] = previewLogos.hiphop;
                logoUrls['Organizaciones Emergentes'] = previewLogos.emergentes;
                logoUrls['Red Intercultural Juvenil'] = previewLogos.juvenil;
                try { const a = document.querySelector('#link-artes img.header-logo'); if (a) a.src = previewLogos.aplp; } catch(e){}
                try { const b = document.querySelector('#link-culturas img.header-logo-right'); if (b) b.src = previewLogos.culturas; } catch(e){}
                debugMsg('PREVIEW_ASSETS activo: usando logos embebidos para vista previa local');
            }
        } catch(e) { console.warn('Error applying preview assets', e); }
        const networkCounts = organizations.reduce((acc, org) => {
            acc[org.network] = (acc[org.network] || 0) + 1;
            return acc;
        }, {});
        const selectedNetworks = new Set(Object.keys(logoUrls));
    const initialView = { center: [4.5709, -74.2973], zoom: 6 };
        function renderFilters(){
            const filtersList = document.getElementById('filters-list');
            filtersList.innerHTML = '';
            for (const network in logoUrls) {
                const item = document.createElement('div');
                const cls = 'network-' + network.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                item.className = 'legend-item filter-option ' + cls + (selectedNetworks.has(network) ? ' active' : '');
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.type = 'button';
                btn.setAttribute('aria-pressed', selectedNetworks.has(network) ? 'true' : 'false');
                const count = networkCounts[network] || 0;
                btn.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${logoUrls[network]}" class="legend-logo" alt="Logo de ${network}">
                        <span>${network}</span>
                    </div>
                    <span class="network-count">${count}</span>
                `;
                btn.addEventListener('click', () => {
                    if (selectedNetworks.has(network)) { selectedNetworks.delete(network); item.classList.remove('active'); btn.setAttribute('aria-pressed', 'false'); }
                    else { selectedNetworks.add(network); item.classList.add('active'); btn.setAttribute('aria-pressed', 'true'); }
                    updateMarkers(searchInput.value);
                });
                item.appendChild(btn);
                filtersList.appendChild(item);
            }
            try { debugMsg('Filtros renderizados. Activos: ' + Array.from(selectedNetworks).join(', ')); } catch(e){}
        }
        const suggestionsEl = document.getElementById('search-suggestions');
    let searchOverrideId = null;
        function clearSuggestions(){ suggestionsEl.innerHTML = ''; suggestionsEl.style.display = 'none'; activeSuggestionIndex = -1; }
        let activeSuggestionIndex = -1;
        function updateSuggestionHighlight(){
            const items = Array.from(suggestionsEl.querySelectorAll('.suggestion-item'));
            items.forEach((it, i) => {
                if (i === activeSuggestionIndex) { it.classList.add('highlight'); it.setAttribute('aria-selected','true'); try{ it.scrollIntoView({block:'nearest'});}catch(e){} }
                else { it.classList.remove('highlight'); it.setAttribute('aria-selected','false'); }
            });
        }
        function showSuggestions(matches){
            suggestionsEl.innerHTML = '';
            if (!matches.length) { clearSuggestions(); return; }
            matches.forEach((m, idx) => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.setAttribute('role','option');
                div.setAttribute('data-index', String(idx));
                div.setAttribute('tabindex','-1');
                div.innerText = m.name;
                div.addEventListener('pointerdown', (ev) => { ev.preventDefault(); performSearch(m); clearSuggestions(); });
                suggestionsEl.appendChild(div);
            });
            suggestionsEl.style.display = 'block';
            activeSuggestionIndex = -1; updateSuggestionHighlight();
        }
        function findMatches(q){
            if (!q) return [];
            const term = q.toLowerCase();
            return organizations.filter(org => 
                org.name.toLowerCase().includes(term) || 
                org.project.toLowerCase().includes(term) ||
                (org.city && org.city.toLowerCase().includes(term))
            );
        }
        function performSearch(org){
            let targetOrg = org;
            if (typeof org === 'string') {
                const matches = findMatches(org);
                targetOrg = matches.length ? matches[0] : null;
            }
            if (!targetOrg) {
                debugMsg('No se encontr√≥ la organizaci√≥n');
                return;
            }
            const id = String(organizations.indexOf(targetOrg));
            searchOverrideId = id;
            try { searchInput.value = targetOrg.name; } catch(e){}
            try { updateMarkers(searchInput.value); } catch(e) { console.warn('updateMarkers after performSearch', e); }
            const marker = markersById.get(id);
            if (marker) {
                try { marker.openPopup(); marker.setZIndexOffset(1000); } catch(e){}
                if (window.innerWidth <= 800) {
                    panel.classList.remove('show');
                }
                try { map.setView(marker.getLatLng(), Math.max(map.getZoom(), 10), { animate: true }); } catch(e){}
            } else {
                setTimeout(() => {
                    const m2 = markersById.get(id);
                    if (m2) { try { m2.openPopup(); map.setView(m2.getLatLng(), Math.max(map.getZoom(), 10), { animate: true }); } catch(e){} }
                }, 250);
            }
        }
        const searchClearBtn = document.getElementById('search-clear-btn');
        searchInput.addEventListener('input', (e) => {
            const v = e.target.value;
            if (!v) { 
                searchOverrideId = null;
                updateMarkers('');
                clearSuggestions(); 
                try {
                    if (map && initialView) map.setView(initialView.center, initialView.zoom, { animate: true });
                    debugMsg('B√∫squeda borrada: restaurando vista inicial y marcadores segun filtros');
                } catch(e){ console.warn('restore initial view', e); }
                try { if (searchClearBtn) searchClearBtn.classList.remove('visible'); } catch(e){}
                return; 
            }
            try { if (searchClearBtn) searchClearBtn.classList.add('visible'); } catch(e){}
            const matches = findMatches(v).slice(0,6);
            showSuggestions(matches);
        });
        searchInput.addEventListener('keydown', (e) => {
            const items = Array.from(suggestionsEl.querySelectorAll('.suggestion-item'));
            if (!items.length) return;
            if (e.key === 'ArrowDown'){
                e.preventDefault(); activeSuggestionIndex = Math.min(items.length - 1, activeSuggestionIndex + 1); updateSuggestionHighlight();
            } else if (e.key === 'ArrowUp'){
                e.preventDefault(); activeSuggestionIndex = Math.max(0, activeSuggestionIndex - 1); updateSuggestionHighlight();
            } else if (e.key === 'Enter'){
                if (activeSuggestionIndex >= 0 && items[activeSuggestionIndex]){
                    e.preventDefault(); const idx = parseInt(items[activeSuggestionIndex].getAttribute('data-index'),10); const matches = findMatches(searchInput.value).slice(0,6); performSearch(matches[idx]); clearSuggestions();
                }
            } else if (e.key === 'Escape'){
                clearSuggestions();
            }
        });
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter'){
                e.preventDefault();
                const q = searchInput.value.trim();
                if (q) performSearch(q);
                clearSuggestions();
            }
            if (e.key === 'Escape') clearSuggestions();
        });
        searchBtn.addEventListener('click', (e) => { const q = searchInput.value.trim(); if (q) performSearch(q); clearSuggestions(); });
        if (searchClearBtn) {
            searchClearBtn.addEventListener('click', (ev) => {
                ev.preventDefault();
                try { searchInput.value = ''; } catch(e){}
                searchOverrideId = null;
                updateMarkers('');
                clearSuggestions();
                try { searchClearBtn.classList.remove('visible'); } catch(e){}
                try { if (map && initialView) map.setView(initialView.center, initialView.zoom, { animate: true }); } catch(e){}
                debugMsg('B√∫squeda borrada por X: restaurando vista inicial');
            });
        }
        let map;
        let dayTiles, nightTiles, currentBase;
        function initMap() {
            if(typeof L === 'undefined') return;
            map = L.map('map', { zoomControl: false }).setView([4.5709, -74.2973], 6);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            dayTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO & OpenStreetMap contributors'
            });
            nightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO & OpenStreetMap contributors'
            });
            if (document.body.classList.contains('dark-mode')) {
                nightTiles.addTo(map);
                currentBase = 'night';
            } else {
                dayTiles.addTo(map);
                currentBase = 'day';
                document.getElementById('map').classList.add('day-enhance');
            }
            setTimeout(() => { try { map.invalidateSize(); debugMsg('Mapa inicializado y redraw ejecutado'); } catch(e) { console.warn('invalidateSize fall√≥', e); } }, 300);
            window.addEventListener('resize', () => { try { map.invalidateSize(); showStatus(); } catch(e){} });
            map.on('click', () => {
                if (window.innerWidth <= 800 && panel.classList.contains('show')) {
                    panel.classList.remove('show');
                }
            });
            try { setupMarkers(); } catch(e){ console.warn('setupMarkers fall√≥', e); }
        }

        function toggleDesktopPanel() {
            appContainer.classList.toggle('panel-collapsed');
            setTimeout(() => { try { map.invalidateSize(); } catch(e) { console.warn(e); } }, 350);
        }
        function toggleMobilePanel() { panel.classList.toggle('show'); }
        desktopToggleButton.addEventListener('click', toggleDesktopPanel);
        mobileToggleButton.addEventListener('click', toggleMobilePanel);
        closeButton.addEventListener('click', toggleMobilePanel);

        const ICON_MOON = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        const ICON_SUN = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4" stroke="white" stroke-width="1.6"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        function setTheme(isDark, persist = false){
            if (isDark) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            try{ document.getElementById('panel-theme-toggle-btn').innerHTML = isDark ? ICON_SUN : ICON_MOON; } catch(e){}
            try{
                if(isDark){ if(currentBase === 'day'){ map.removeLayer(dayTiles); nightTiles.addTo(map); currentBase = 'night'; } document.getElementById('map').classList.remove('day-enhance'); }
                else { if(currentBase === 'night'){ map.removeLayer(nightTiles); dayTiles.addTo(map); currentBase = 'day'; } document.getElementById('map').classList.add('day-enhance'); }
            }catch(e){ /* may run before map init */ }
            document.querySelectorAll('.filter-btn').forEach(b => { if (isDark) b.classList.add('night-mode'); else b.classList.remove('night-mode'); });
            // Se elimina la persistencia en localStorage para que el tema se base siempre en la hora
        }

        function initTheme(){
            // Se elimina la l√≥gica de localStorage para que el comportamiento por defecto sea siempre basado en la hora.
            try{
                const now = new Date();
                const h = now.getHours();
                const m = now.getMinutes();
                let isNight;
                // Regla espec√≠fica: Nocturno es de 18:01 a 05:59. Diurno es de 06:00 a 18:00.
                if (h < 6) { 
                    isNight = true;
                } else if (h >= 19) { 
                    isNight = true;
                } else if (h === 18 && m >= 1) { 
                    isNight = true;
                } else { // El resto es diurno (de 06:00 a 18:00 inclusive)
                    isNight = false;
                }
                setTheme(isNight, false);
            }catch(e){
                // si la l√≥gica de la hora falla, usa la preferencia del sistema como √∫ltimo recurso.
                const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
                const systemDark = mq && mq.matches;
                setTheme(!!systemDark, false);
            }
        }

        try { initTheme(); } catch(e){}
        try { document.getElementById('panel-theme-toggle-btn').addEventListener('click', () => { const isDark = !document.body.classList.contains('dark-mode'); setTheme(isDark, true); }); } catch(e){}

        
        let markers = null;
        function updateMarkers(searchTerm = '') {
            if (!markers) return;
            markers.clearLayers();
            markersById.clear();
            let filteredOrgs = [];
            if (searchOverrideId !== null) {
                const idx = parseInt(searchOverrideId, 10);
                if (!Number.isNaN(idx) && organizations[idx]) {
                    filteredOrgs = [organizations[idx]];
                }
            } else {
                const selected = Array.from(selectedNetworks);
                filteredOrgs = organizations.filter(org => selected.includes(org.network));
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredOrgs = filteredOrgs.filter(org =>
                        org.name.toLowerCase().includes(term) ||
                        org.project.toLowerCase().includes(term) ||
                        (org.city && org.city.toLowerCase().includes(term))
                    );
                }
            }
            filteredOrgs.forEach(org => {
                const iconSize = 38;
                const iconUrl = logoUrls[org.network] || placeholderLogo;
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [iconSize, iconSize], iconAnchor: [iconSize / 2, iconSize], popupAnchor:  [0, -iconSize]
                });
                let popupHtml = `<div class="popup-content"><h5>${org.name}</h5><p><strong>Ciudad:</strong> ${org.city}</p><p><strong>Proyecto:</strong> ${org.project}</p><p><strong>Fechas:</strong> ${org.dates}</p>`;
                if (org.link) popupHtml += `<p><a href="${org.link}" target="_blank">M√°s informaci√≥n</a></p>`;
                if (org.image) popupHtml += `<img src="${org.image}" alt="Imagen" style="width:100%;margin-top:8px;border-radius:6px;">`;
                popupHtml += '</div>';
                const marker = L.marker([org.lat, org.lng], { icon: customIcon, network: org.network });
                marker.bindTooltip(`${org.name} - ${org.city}`);
                marker.bindPopup(popupHtml);
                markers.addLayer(marker);
                const id = organizations.indexOf(org);
                markersById.set(String(id), marker);
            });
            try { debugMsg(`Marcadores mostrados: ${filteredOrgs.length} (override: ${searchOverrideId})`); } catch(e){}
            setTimeout(() => { try { map.invalidateSize(); } catch(e){ console.warn('invalidate after markers', e); } }, 50);
        }

        function setupMarkers(){
            const clusterAvailable = (typeof L.markerClusterGroup === 'function');
            if(clusterAvailable){
                markers = L.markerClusterGroup({
                    zoomToBoundsOnClick: false,
                    showCoverageOnHover: false,
                    spiderfyOnMaxZoom: false,
                    spiderfyDistanceMultiplier: 2.2,
                    iconCreateFunction: function(cluster) {
                        const children = cluster.getAllChildMarkers();
                        const counts = {};
                        let dominantNetwork = '';
                        let maxCount = 0;
                        children.forEach(marker => {
                            const network = marker.options.network;
                            counts[network] = (counts[network] || 0) + 1;
                        });
                        for (const network in counts) {
                            if (counts[network] > maxCount) {
                                maxCount = counts[network];
                                dominantNetwork = network;
                            }
                        }
                        let c = ' marker-cluster-';
                        if (dominantNetwork === 'Red Hip Hop') c += 'hiphop';
                        else if (dominantNetwork === 'Organizaciones Emergentes') c += 'emergentes';
                        else if (dominantNetwork === 'Red Intercultural Juvenil') c += 'juvenil';
                        else if (dominantNetwork === 'Red de Mujeres') c += 'mujeres'; // A√±adido para la nueva red
                        return new L.DivIcon({
                            html: '<div><span>' + cluster.getChildCount() + '</span></div>',
                            className: 'marker-cluster' + c, iconSize: new L.Point(40, 40)
                        });
                    }
                });
                markers.on('clusterclick', function (a) {
                    try{
                        const z = map.getZoom();
                        const minZ = 3; const maxZ = 13;
                        const t = Math.max(0, Math.min(1, (z - minZ) / (maxZ - minZ)));
                        const multiplier = 1.1 + t * (2.6 - 1.1);
                        if (markers && markers.options) markers.options.spiderfyDistanceMultiplier = multiplier;
                        debugMsg(`spiderfyMultiplier: ${multiplier.toFixed(2)} (zoom ${z})`);
                        a.layer.spiderfy();
                    }catch(e){ console.warn('clusterclick handler', e); }
                });
            } else {
                console.warn('MarkerCluster no disponible, usando layerGroup como fallback');
                markers = L.layerGroup();
            }

            map.addLayer(markers);
            updateMarkers();
            debugMsg('Marcadores inicializados (cluster: ' + clusterAvailable + ')');
        }

    });
        (function(){
            function createTooltip(text){
                const tip = document.createElement('div');
                tip.className = 'header-tooltip';
                tip.setAttribute('role','status'); tip.setAttribute('aria-live','polite');
                tip.textContent = text;
                document.body.appendChild(tip);
                return tip;
            }
            function positionTooltip(tip, anchor){
                if(!tip || !anchor) return;
                const rect = anchor.getBoundingClientRect();
                const left = rect.left + rect.width / 2 - tip.offsetWidth / 2;
                const top = rect.top - tip.offsetHeight - 8;
                tip.style.left = Math.max(8, left) + 'px';
                tip.style.top = Math.max(8, top) + 'px';
            }
            function attachTooltip(anchorId, text){
                const anchor = document.getElementById(anchorId);
                if(!anchor) return;
                const tip = createTooltip(text);
                let visibleTimeout = null;
                function show(){ tip.classList.add('show'); positionTooltip(tip, anchor); clearTimeout(visibleTimeout); }
                function hide(){ visibleTimeout = setTimeout(()=> tip.classList.remove('show'), 80); }
                anchor.addEventListener('mouseenter', show);
                anchor.addEventListener('focus', show);
                anchor.addEventListener('mouseleave', hide);
                anchor.addEventListener('blur', hide);
                anchor.addEventListener('click', ()=>{ tip.classList.add('show'); positionTooltip(tip, anchor); setTimeout(()=> tip.classList.remove('show'), 800); });
                window.addEventListener('resize', ()=> positionTooltip(tip, anchor));
                window.addEventListener('scroll', ()=> positionTooltip(tip, anchor));
            }
            attachTooltip('link-artes', 'Volver a la p√°gina de Artes para la Paz');
            attachTooltip('link-culturas', 'Ir al Ministerio de las Culturas, las Artes y los Saberes de Colombia');
        })();
    </script>
    <!-- C√≥digo desarrollado por Felipe Camacho Otero, en colaboraci√≥n con Gemini y Copilot -->
</body>
</html>

